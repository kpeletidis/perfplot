#!/bin/bash
#
# Perfplot is a tool for visualizing performance results e.g. from the
# output of dbench.
# Copyright (C) Kostas Peletidis 23-Dec-2022
#

## Design
#  =======
# Perfplot takes as input a set of command line argument and a file containing
# the test results.
#
# It processes the results to extract the actual data and generates one or more
# data files. It also generates one or more gnuplot scripts.
#
# The data and script(s) are then fed into gnuplot in order to generate
# the plots.
#
# The following diagram illustrates the main idea.
#
#  +--------------+       +----------+       +------------+       +---------+
#  | Test results |------>|          |------>| Data files |------>|         |
#  +--------------+       |          |       +------------+       |         |
#                         | Perfplot |                            | Gnuplot |
#  +----------------+     |          |       +---------------+    |         |
#  | CLI parameters |---->|          |------>| Gnuplot files |--->|         |
#  +----------------+     +----------+       +---------------+    +---------+
#
##
## Configuration (global) variables go here
infile=""

function parse_args_dbench() {
  echo "parse_args_dbench: $*"
}

## This function should parse CLI arguments and assign the correct values
## to the global configuration variables.
function parse_args() {
  echo "parse_args: $*"
  infile="$1"
  parse_args_dbench $*
}

function extract_data_dbench() {
  echo "extract_data_dbench: infile=$1"
}

function extract_data() {
  echo "extract_data: infile=$1"
  tmpfile=$(mktemp /tmp/perfplot-perdata.XXXXXX)
  tmpwarmup=$(mktemp /tmp/perfplot-warmup.XXXXXX)
  tmpexecute=$(mktemp /tmp/perfplot-execute.XXXXXX)
  grep -w latency $1 > "$tmpfile"
  grep -w warmup "$tmpfile" > "$tmpwarmup"
  grep -w execute "$tmpfile" > "$tmpexecute"
  #
  extract_data_dbench "$1"
}

function generate_plot_scripts_dbench() {
  echo "generate_plot_scripts_dbench: $1"
  # For dbench plots:
  # Use columns 6:3 for throughput plots
  # Use columns 6:9 for latency plots
}

function generate_plot_scripts() {
  echo "generate_plot_scripts: $1"
}

function plot_data() {
  echo "plot_data: $1"
}

parse_args $*
extract_data "$infile"
generate_plot_scripts "Generate gnuplot scripts here"
plot_data "Plot data here"

exit 0

